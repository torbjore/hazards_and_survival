---
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: true
#    fig_caption: true
#    keep_tex: yes
#  documentclass: 'article'
  html_document: default
header-includes:
  \usepackage{float}
  \usepackage{amsmath}
  \DeclareMathOperator{\Var}{Var}
  \DeclareMathOperator{\VSS}{VSS}
  
title: "Supporting information for 'Study mortality with hazard rates, not probabilities'"

author: Torbj\o rn Ergon$^{a*}$, \O rnulf Borgan$^{b}$, Chloe Rebecca Nater$^{a}$
  and Yngvild Vindenes$^{a}$
date: "`r Sys.Date()`"

abstract: This document provides additional information relating to each section and figure in the main article (<https://doi.org/10.1101/216739> (link will be updated upon acceptance in the journal)). The document is written in R Markdown. The Markdown source file (.Rmd) is available at [XXX]. It contains all R-code needed to reproduce all figures and examples in this document (see <https://rmarkdown.rstudio.com/>).
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```

\bigskip

$^{a}$Centre for Ecological and Evolutionary Synthesis, Department of Biosciences, University of Oslo, P.O. Box 1066 Blindern, N-0316 Oslo, Norway

$^{b}$Department of Mathematics, University of Oslo, P.O. Box 1066 Blindern, N-0316 Oslo, Norway

$^{*}$Corresponding author: e-mail: t.h.ergon@ibv.uio.no

\newpage
\setcounter{section}{1}

# Appendix S1: Details on sections and figures {-}

The headings below are the same as in the article and contains explanations and R-code for the figures referred to under each heading.

## Introduction (Box 1)

### Another derivation of the relationship between mortality hazard rates and survival probabilities

In Box 1 we explained the relationship between individual mortality hazard rates and survival probabilities (eq. (1) in the main text) by considering an individual point process for deadly events. We chose this approach to give an intuitive understanding of the hazard rate as an "intensity of deadly events" that individuals are exposed to and to set the stage for explaining the issue of competing risks in an intuitive manner in Appendix S2. Another way to derive this relationship is to consider a population of $N(t_1)$ identical individuals having identical expectations for their future environment at time $t_1$. If there is no reproduction, the instantaneous rate of change in population size, $N(t)$, will be
$$\frac{\partial N(t)}{\partial t} = -hN(t)$$
where $h$ is the mortality hazard rate in units of $t^{-1}$, here considered to be constant. Solving for $N(t_1+\Delta)$ as a function of $N(t_1)$ gives
$$N(t_1+\Delta) = N(t_1)e^{-h\Delta}$$
To convert this to a survival probability over the interval, we divide by $N(t_1)$,
$$S_{t_1 \rightarrow t_1+\Delta}=\frac{N(t_1+\Delta)}{N(t_1)}=e^{-h\Delta}$$
If the mortality hazard rate is considered as a continuous function of time, $h(t)$, we can calculate the survival probability as a product of many infinitesimally small sections of the interval from time $t_1$ to $t_2$ to obtain eq. (1) in the main text,
$$S_{t_1 \rightarrow t_2}= e^{-\int_{t_1}^{t_2}h(t)dt}.$$

## Logit-linear models of survival vs. log-linear models of mortality rates

### Relationships

Survival probabilities, $S$, in any discrete-time model can be replaced by $S = \exp(-\bar{h})$, where $\bar{h}$  is the time-averaged mortality hazard rate in the given time interval(s). The unit of measurement for $\bar{h}$ is here the inverse of the length of the interval (see Box 1 in the main text). That is, if $S$ is the probability of surviving one year, the unit of $\bar{h}$ is year$^{-1}$, whereas if $S$ is the probability of surviving one month, the unit of $\bar{h}$ is month$^{-1}$.


$\qquad$ Since $\bar{h}$ is a ratio-scaled intensity, it is natural to model multiplicative (proportional) effects on $\bar{h}$ through a log-link,
$$\bar{h} = \exp(\eta),$$
where $\eta$ is a linear predictor of explanatory variables,
$$\eta = \beta_{0} + \beta_{1}x_{1} + \beta_{2}x_{2} + ...$$
This corresponds to using a loglog link-function on survival probabilities,
$$S = \exp(-\bar{h}) = \exp(-\exp(\eta))$$
The exponent of contrasts in the linear predictor (e.g. representing individuals with different body mass or sex) then become hazard ratios[^fn:alt_loglog],
$$\exp(\eta_2 - \eta_1) = \frac{\exp(\eta_2)}{\exp(\eta_1)} = \frac{\bar{h}_2}{\bar{h}_1}.$$

[^fn:alt_loglog]: Note that some computer programs, such as MARK, define the inverse loglog-link as $S = \exp(-\exp(-\eta))$, in which case the hazard ratio $\frac{\bar{h}_2}{\bar{h}_1}$ becomes $\exp(\eta_1 - \eta_2)$.

$\qquad$ One may chose to reparameterize the discrete-time model with e.g. monthly survival probabilities ($S_m$) instead of yearly survival probabilities ($S_y$). If one assumes that all months of the year have the same survival probability, this amounts to just replacing all $S_y$ in the model with $(S_m)^{12}$.[^fn:reparam] When using a loglog-link on survival probabilities, the model is invariant to such replacements because the time-averaged hazard rate remains unchanged. If this does not appear as obvious, one may see this better by first calculating the time-averaged hazard rate as $\bar{h}_y = \exp(\eta_y) = -\log(S_y)$. The unit for $\bar{h}_y$ is here year$^{-1}$. Similarly, the time-averaged hazard rate can also be calculated as $\bar{h}_m = \exp(\eta_m) = -\log(S_m)$, where $\bar{h}_m$ is expressed in units of month$^{-1}$. Since $S_y = (S_m)^{12}$, we see that $\bar{h}_y = -\log((S_m)^{12}) = -12\log(S_m) = 12\bar{h}_m$, and since an intensity of one event per month is the same as an intensity of 12 events per year, the two hazard rates $\bar{h}_y$ and $\bar{h}_m$ are identical (they just have different units of expression). Note also that the ratio of two hazard rates (i.e., hazard ratios) are invariant to which unit of expression is used for the hazard rates. Hence, when modelling survival probabilities through a loglog-link, all parameters in the linear predictor except the intercept are invariant to reparameterizations on the form $S_y = (S_m)^{12}$. This can be seen from expanding $\bar{h}_y = 12\bar{h}_m$,
$$\bar{h}_y = 12\bar{h}_m = 12\exp(\beta_0 + \beta_{1}x_{1} + \beta_{2}x_{2} + ...) = \exp((\log(12) + \beta_0) + \beta_{1}x_{1} + \beta_{2}x_{2} + ...) $$

[^fn:reparam]: Note that this is a reparameterization since $S_y$ and $S_m$ have different meanings - it is not about "selecting a time-scale for the survival probabilities". Survival probabilities are unit-free absolute scale measurements that cannot be "re-scaled" in any way. Such reparameterizations of the general (full, unconstrained) model may be specified in e.g. MARK, and is commonly done when time between trapping occasions vary over the study period.

$\qquad$ It is (unfortunately) common practice to model effects of covariates on survival probabilities through the use of a logit link-function. That is, survival probability is modelled as
$$S=\frac{\exp(\eta)}{1+\exp(\eta)},$$
where $\eta$ is the linear predictor. The exponent of the linear predictor then becomes the survival-odds,
$$\exp(\eta)=\frac{S}{1-S}.$$
Just like survival probabilities,  but unlike hazard rates, survival-odds are unit-free absolute scale measurements that cannot be transformed in any way without losing their original meaning. 

$\qquad$ If we fit an effect of a time-invariant covariate (e.g., an individual covariate) on monthly survival using a logit-link, the relationship between the covariate and yearly survival will be
$$S_y=\left( \frac{\exp(\eta)}{1+\exp(\eta)} \right)^{12}$$
which is not easily simplified. Hence, replacing  $S_y$ with $(S_m)^{12}$ changes the functional form of the model when survival probabilities are modelled by a logit-link involving continuous covariates. In contrast, when using a loglog-link, we obtain
$$S_y = (\exp(-\bar{h}_m))^{12} = \left( \exp(-\exp(\eta)) \right)^{12} = \exp(-12\exp(\eta)) = \exp(-\bar{h}_y),$$
and, as also explained above, the functional relationships between the covariates and survival remains unchanged (only the intercept is changed to reflect the change in unit of expression for the time-averaged hazard rates).

### Figure 1
Figure 1 in the main text illustrates the effect of replacing  $S_y$ with $(S_n)^n$ where $1/n$ is the length of the time-intervals used in the discrete model. To facilitate comparison of functional shapes, the intercepts and slopes of logit survival for all curves are defined such that yearly survival probability equals 0.05 when the covariate value is -2 and 0.95 when the covariate value is 2. If the models were fitted to data, the functional forms would be the same as in the figure, and predicted values would be in the same range, but the curves would not necessarily cross at the same place.

#### Code - Figure 1:
```{r, fig.height=5, fig.width=7, fig.cap="Functional shape of the relationship between yearly survival and a time-invariant covariate (e.g. individual specific)  when using the logit link-function on survival probability over different time interval lengths (solid coloured lines; see legend). When the logit-link is applied to monthly survival (red line), it is assumed that probability of survival is the same in all of the 12 months of the year, such that $S_{yearly}=S_{monthly}^{12}$. Similarly, when the logit-link is applied to survival over 12 years, $S_{yearly}=S_{12-yearly}^{1/12}$ (green line). To facilitate comparison of functional shapes, slope and intercept parameters are defined such that yearly survival probability is 0.05 at covariate value -2 and 0.95 at covariate value 2. The dashed line shows the loglog-linear relationship between yearly survival and the covariate, which is invariant to the interval length for the survival probability. When the logit-linear relationship applies to survival probabilities over short intervals, it approaches the loglog-linear functional form (see red line).", out.extra=''}
# Defining functions
logit = function(S) log(S/(1-S))
invlogit = function(eta) exp(eta)/(1+exp(eta))
loglog = function(S) log(-log(S))
invloglog = function(eta) exp(-exp(eta))
rescaled.invlogit = function(x, il, s1=0.05, s2 = 0.95){ # il = 'interval length'
  a = mean(c(logit(s2^il), logit(s1^il))) # intercept
  b = (logit(s2^il)-logit(s1^il))/4       # slope
  Sy = invlogit(a + b*x)^(1/il)           # yearly survival
  return(Sy)
}
rescaled.invloglog = function(x, il, s1=0.05, s2 = 0.95){ # il = 'interval length'
  a = mean(c(loglog(s2^il), loglog(s1^il))) # intercept
  b = (loglog(s2^il)-loglog(s1^il))/4       # slope
  Sy = invloglog(a + b*x)^(1/il)            # yearly survival
  return(Sy)
}

# Values for plotting
x = seq(-3,3,length.out=60)
Syy.logit = rescaled.invlogit(x, 1)      # Using logit-link applied to yearly survival
Sym.logit = rescaled.invlogit(x, 1/12)   # Using logit-link applied to monthly survival
Sy12.logit = rescaled.invlogit(x, 12)    # Using logit-link applied to 12-year survival
Syy.loglog = rescaled.invloglog(x, 1)    # Using loglog-link applied to yearly survival
Sym.loglog = rescaled.invloglog(x, 1/12) # Using loglog-link applied to monthly survival

# All Syy.loglog == Sym.loglog (but round-off errors occur, hence using round())
all(round(Syy.loglog, 12) == round(Sym.loglog, 12))

# Making plot
plot(x, Syy.logit, type="l", col="blue",
     xlab="Time-invariant covariate", ylab="Yearly survival")
lines(x, Sym.logit, col="red")
lines(x, Sy12.logit, col="green")
lines(x, Syy.loglog, lty=2)
abline(v=-2, lty=3)
abline(v=2, lty=3)
legend("topleft",
  legend = c(
    expression(logit(italic(S)[monthly])),
    expression(logit(italic(S)[yearly])),
    expression(logit(italic(S)[12-yearly])),
    expression(loglog(italic(S^{n})))
  ),
  lty=c(1,1,1,2), col=c("red", "blue", "green", "black"), bg="white"
)
```

### Figure 2
Odds-ratios are hard to interpret, not only because their meaning depend on the chosen interval length of the discrete-time model, but also because, for a given hazard ratio, they depend on the survival probability of the reference group. This is illustrated in Figure 2 in the main text.

#### Code - Figure 2:
```{r, fig.height=5, fig.width=7, fig.cap="SETTER INN DETTE TIL SLUTT", out.extra=''}
# Function for computing odds-ratio for a given hazard ratio (hr) and survival
# probability of reference group (s1)
OR = function(s1, hr){
  s2 = exp(-(-log(s1)*hr))
  (s2/(1-s2))/(s1/(1-s1))
}
ORv = Vectorize(OR)

# Constants
scale = seq(0, 2.1, length.out=60)      # Survival interval length in years (x-axis)
s = c(0.01, 0.1, 0.25, 0.5, 0.75, 0.99) # Survival probabilities of reference
HR = 0.5                                # Hazard ratio to be used in plot

# Draw the plot
Col = rainbow(length(s))
Col[2] = "#FF8000FF" # Changing the light yellow to orange
plot(1,1, type="n", ylim=c(0,6), xlim=range(scale), axes=F,
     xlab="Survival interval length", ylab="Odds-ratio")
box()
axis(2)
At = c(7/365, 0.5, 1, 2)
Lab = c("1w", "6m", "1y", "2y")
axis(1, at = At, labels=Lab)
abline(v = At, col="grey")
abline(h=1, lty=2)
lines(range(scale), c(HR,HR), lwd=2) # Line for the hazard ratio
for(i in 1:length(s)){
  lines(scale, ORv(s[i]^scale, HR), col=Col[i], lwd=1.5)
}
legend("topleft", legend=s, col=Col, lty=1, bg="white", lwd=1.5,
       title="   Yearly survival of reference   ", ncol=2)

# Adding points corresponding to the examples in the text
points(c(1,2), ORv(c(0.25, 0.25^2), HR), cex=1.7)     # Original environment; odds-ratio
points(c(1,2), c(HR,HR), cex=1.7)                     # Original environment; hazard-ratio
points(c(1,2), ORv(c(0.5, 0.5^2), HR), pch=4, cex=1.7)# Improved environment; odds-ratio
points(c(1,2), c(HR,HR), pch=4, cex=1.7)              # Improved environment; hazard ratio
```

From Fig. 2, it may be noted that odds-ratios approach the inverse of the hazard ratio ($1/0.5 = 2$) when survival probabilities are high; i.e., when the survival probability of the reference is high (pink line) or when interval lengths are short (to the left in the plot).

## Multiple sources of mortality and competing risks 

Mortality hazard rates are more elucidating with respect to the underlying mechanisms than mortality probabilities when studying associations between two or more sources of mortality in a population because mortality probabilities are intrinsically dependent; increasing the hazard rate for one cause of mortality will automatically reduce the probabilities of dying from all other causes (Appendix S2). Figure 3 in the main text shows how this negative intrinsic dependency can dominate empirical correlations between cause specific mortality probabilities across years even when correlations between the cause specific mortality hazard rates are strongly positive. Figure 4 illustrates the relationships between cause-specific mortality hazard rates and survival probabilities in a age-dependent model.

### Figure 3
Figure 3 is produced by simulation. First, $10^5$ values of log hazard rates, $\log(h_1)$ and  $\log(h_2)$, were drawn from a bi-variate normal distribution with means given by the the colour legend (median($h$) = exp(mean(log($h$)))), standard deviations given above each panel, and correlations given by the x-axis. Cause-specific mortality probabilities where then computed from each of the $10^5$ samples, and the Pearson correlation coefficients between them where then computed and plotted on the y-axis.

#### Code - Figure 3:
```{r, fig.height=4, fig.width=7, fig.cap="SETTER INN DETTE TIL SLUTT", out.extra=''}
library(MASS) # for 'mvrnorm'

# Functions
sim.cor = function(sigma, mu){
	Rho = seq(-1,1,length.out=50)
	cor.h = cor.P = median.S = rep(NA, length(Rho))
	for(i in 1:length(Rho)){
		rho = Rho[i] # correlation between log hazards
		S = matrix(c(
		  sigma[1]^2, rho*sigma[1]*sigma[2],
		  rho*sigma[1]*sigma[2], sigma[2]^2), 2,2, byrow=T)
		log.h = mvrnorm(100000, c(mu,mu), S)
		h = exp(log.h)
		# Cause-specific mortality probabilities from Table 1 in main text:
		P1 = (1-exp(-(h[,1]+h[,2])))*h[,1]/(h[,1]+h[,2])
		P2 = (1-exp(-(h[,1]+h[,2])))*h[,2]/(h[,1]+h[,2])
		cor.P[i] = cor(P1,P2)
	}
	return(list(Rho=Rho, cor.P=cor.P))
}

plot.panel = function(sigma){
  H = c(0.01, 0.1, 0.5, 1, 2)
  Mu = log(H)
  Col = rainbow(length(Mu))
  plot(0,0, type="n", xlab=expression(cor(log~italic(h[1]),~log~italic(h[2]))),
       ylab=expression(cor(italic(P[1]),~italic(P[2]))))
  abline(0,1, col="grey")
  abline(v=c(-1,0,1), col="grey")
  abline(h=c(-1,0,1), col="grey")
  for(i in 1:length(Mu)){
    X = sim.cor(rep(sigma,2), mu=Mu[i])
    lines(X$Rho, X$cor.P, col=Col[i])
  }
  legend("topleft", lty=1, col=Col, legend=H, title=expression(Median~italic(h)), 
         bg="white")
}

# Make each panel
par(mfrow=c(1,3))
plot.panel(1)
title(expression(SD(log~italic(h)) == 1))
plot.panel(.1)
title(expression(SD(log~italic(h)) == 0.1))
plot.panel(.01)
title(expression(SD(log~italic(h)) == 0.01))
```

### Figure 4
Figure 4 illustrates the fact that, if one of two cause specific mortality *probabilities* is constant (red line in panel a) while the other increases with age, both cause specific mortality *hazard rates* must increase with age (panel b).

#### Code - Figure 4
```{r, fig.height=5, fig.width=8, fig.cap="SETTER INN DETTE FRA MANUS TIL SLUTT", out.extra=''}
# Parameters chosen to resemble Fig. 4 in Koons et al. 2014
x = 1:17 # Age (x-axis values)
c = 12 # Age at 50% survival
b = .45 # Slope

# Cause-specific mortality probabilities
P1 = rep(0.06, length(x)) # Human related
P2 = 1/(1+exp(-(b*(x-c)))) # Natural

# Corresponding time-averaged mortality hazard rates from Table 1 in main text
m1 = -log(1-P1-P2)*P1/(P1+P2)
m2 = -log(1-P1-P2)*P2/(P1+P2)

# Plotting the two panels:
par(mfrow=c(1,2))

plot(mean(x),mean(P2), xlim=range(x), ylim=c(0,1), type="n",
     ylab="Mortality probability", xlab="Age")
lines(x,P2, col="blue")
points(x,P2, col="blue", pch=21, bg='white')
lines(x,P1, col="red")
points(x,P1, col="red", pch=19)
legend("topleft", legend=c("Human-related", "Natural"), col=c("red","blue"),
       pch=c(19,21), pt.bg = 'white', lty=1)
title("(a)", adj=0)

plot(mean(x),mean(m2), xlim=range(x), ylim=range(c(m1,m2)), type="n", log="y",
     ylab="Mortality hazard rate", xlab="Age")
lines(x,m2, col="blue")
points(x,m2, col="blue", pch=21, bg='white')
lines(x,m1, col="red")
points(x,m1, col="red", pch=19)
legend("topleft", legend=c("Human-related", "Natural"), col=c("red","blue"),
       pch=c(19,21), pt.bg='white', lty=1)
title("(b)", adj=0)
```

## Analyses of elasticity of population growth rate to survival probabilities versus mortality hazard rates

### Relationships

In the main text, the relationship between elasticity of population growth rate $\lambda$ to survival probability $S$ over an interval, $\epsilon_{S}$, and elasticity to time-averaged mortality hazard rate $\bar{h}$ during the same interval, $\epsilon_{\bar{h}}$, is given as
$$\epsilon_{\bar{h}}=-\bar{h}\epsilon_{S}$$
To derive this, note the relationship $\bar{h}=-\log(S)$ (eq. (2) in the main text), and remember that the elasticities are defined as $\epsilon_{\bar{h}} = \frac{\partial \log(\lambda)}{\partial \log(\bar{h})}$ and $\epsilon_{S} = \frac{\partial \log(\lambda)}{\partial \log(S)}$. By using the chain rule of derivation, we get
$$\epsilon_{\bar{h}} 
= \frac{\partial \log(\lambda)}{\partial \log(\bar{h})}
= \frac{\partial \log(\lambda)}{\partial \log(S)} \frac{\partial \log(S)}{\partial \log(\bar{h})}
= \epsilon_{S}\frac{\partial (-\bar{h})}{\partial \log(\bar{h})}
= \epsilon_{S}(-\bar{h})
= \epsilon_{S} \log(S).
$$
$\qquad$ If the above survival probability applies to one year, $S_y$, one may chose to reparameterize the model with monthly survival probabilities, $S_m$, assuming that all months of the year have the same survival probability such that $S_y = S_m^{12}$ and $\log(S_y) = 12\log(S_m)$. The relationship between the elasticities of these two survival probabilities is
$$
\epsilon_{S_m}
= \frac{\partial \log(\lambda)}{\partial \log(S_m)}
= \frac{\partial \log(\lambda)}{\partial \log(S_y)} \frac{\partial \log(S_y)}{\partial \log(S_m)}
= \epsilon_{S_y} 12
$$
$\qquad$ Elasticities to instantaneous mortality hazard rates, or their time-averaged values ($\bar{h}=-\log(S)$), are invariant to any such reparameterizations with respect to the choice of interval length of the discrete model. If this is not intuitive, consider the relationship $\epsilon_{\bar{h}} = \epsilon_{S_y} \log(S_y) = \frac{1}{12} \epsilon_{S_m}12\log(S_m) = \epsilon_{S_m} \log(S_m)$.

$\qquad$ As pointed out by Link \& Doherty (2002), the relationship between elasticity to mortality probability, $\epsilon_P$, and elasticity to survival probability, $\epsilon_S$, is
$$
\epsilon_P
= \frac{\partial \log(\lambda)}{\partial \log(1-S)}
= \frac{\partial \log(\lambda)}{\partial \log(S)} \frac{\partial \log(S)}{\partial \log(1-S)}
= \epsilon_S \frac{\partial S}{\partial (1-S)} \frac{1-S}{S}
= -\epsilon_S \left( \frac{1-S}{S} \right).
$$
That is, a given relative decrease in morality probability only has the same impact on population growth rate (or fitness) as the same relative increase in survival probability when $S=0.5$. Moving away for $S=0.5$ in either direction, these two elasticities will be increasingly different. It seems hard to justify why any of these elasticities should be more relevant than the other (Link \& Doherty 2002); they represent very different degrees of change in the mortality process when $S$ is not close to $0.5$. Elasticity to mortality hazard rate, on the other hand, has a clear and meaningful interpretation; it is the relative change in population growth rate caused by a relative increase in the intensity at which individuals die (Box 1 in the main text).

### Figures 5 and 6

Figures 5 and 6 illustrate the differences between elasticities of $\lambda$ to $S$ and to $\bar{h}$ by using a very simple two-stage population model without density dependence. With a post-reproductive census (Caswell 2001, p. 27), this model can be written as
$$
\left[
\begin{array}{c}
N_j \\ N_a
\end{array}
\right]_t
=
\left[
\begin{array}{cc}
S_jm & S_am \\ S_j & S_a
\end{array}
\right]
\left[
\begin{array}{c}
N_j \\ N_a
\end{array}
\right]_{t-1}
$$
where indices $j$ and $a$ represent respectively 'juveniles' (newborn) and 'adults' (1 year or older), $N$ is number of individuals, $S$ is survival probability and $m$ is fecundity. Index value $t$ is the time-step (year).

$\qquad$ With a pre-reproductive census, there are no counts of newborn, and the dynamics of the population is simply described by
$$
N_{a,t} = N_{a,t-1}(S_a + mS_j)
$$
Hence, the population growth rate in this model is
$$
\lambda = \frac{N_{a,t}}{N_{a,t-1}} = (S_a + mS_j).
$$
From this we can calculate elasticities of $\lambda$ to survival probabilities and their corresponding time averaged mortality hazard-rates,
$$
\begin{array}{l}
\epsilon_{S_a} 
= \frac{\partial \log(\lambda)}{\partial \log(S_a)}
= \frac{\partial \lambda}{\partial S_a} \frac{S_a}{\lambda}
= \frac{S_a}{S_a + mS_j}
\\\\
\epsilon_{S_j} 
= \frac{\partial \log(\lambda)}{\partial \log(S_j)}
= \frac{\partial \lambda}{\partial S_j} \frac{S_j}{\lambda}
= \frac{mS_j}{S_a + mS_j}
\\\\
\epsilon_{\bar{h}_a} 
= -\bar{h}_a \epsilon_{S_a}
\\\\
\epsilon_{\bar{h}_j} 
= -\bar{h}_j \epsilon_{S_j}
\end{array}
$$
The elasticity ratio with respect to survival probabilities is thus
$$
\frac{\epsilon_{S_a}}{\epsilon_{S_j}}
= \frac{S_a}{mS_j}
$$
(i.e., $\epsilon_{S_a}$ is grater that $\epsilon_{S_j}$ when $S_a > mS_j$). The elasticity ratio with respect to time-averaged mortality hazard rates is
$$
\frac{\epsilon_{\bar{h}_a}}{\epsilon_{\bar{h}_j}}
= \frac{\bar{h}_a}{\bar{h}_j} \frac{S_a}{mS_j}
$$
$\qquad$ Figure 5 in the main text shows the effect of reparameterizing the model with survival probabilities representing different interval lengths, and Figure 6 compares elasticity ratios with respect to survival probabilities and time-averaged mortality hazard rates. Although these figures could have been produced simply by using the relationships derived for the two-stage model above, we have chosen to do it in a more general way using the 'vitalsens' function in the 'popbio' R-package (Stubben \& Milligan 2007). Hence, the code below can quite easily be adapted to any matrix population model or other kinds or reparameterizations.

#### Code - Figure 5
```{r, fig.height=6, fig.width=9, fig.cap="SETTER INN DETTE FRA MANUS TIL SLUTT", out.extra=''}
library(popbio) # For function 'vitalsens'

# Function for elastisities with reparameterization of survival probabilities 
# representing different interval lengths
ela_S = function(
    Sj.y,  # Yearly juveile survival
    Sa.y,  # Yealry adult survival
    m,     # Fecundity
    t      # No. time units per year
  ){
  el = expression(  # Expressions for each of the matrix elements in a vector (by row)
    Sj.t^t*m, Sa.t^t*m,
    Sj.t^t, Sa.t^t
  )
  vr = list(Sj.t=Sj.y^(1/t), Sa.t=Sa.y^(1/t), m=m, t=t) # Num. values for demogr. params.
  v = vitalsens(el, vr)
  elas = v$elasticity
  names(elas) = rownames(v)
  return(elas)
}

# Above function allowing vector inputs for t
Ela_S = Vectorize(ela_S, "t")

# Using same structure to also reparameterizing survival probabilities with respect to
# time averaged hazard rates
# This can be substantially simplified, but keeping the general structure as an example
# and for validation
ela_h = function(Sj.y, Sa.y, m, t){
  el = expression(
    exp(-hj.t)^t*m, exp(-ha.t)^t*m,
    exp(-hj.t)^t, exp(-ha.t)^t
  )
  vr = list(hj.t=-log(Sj.y^(1/t)), ha.t=-log(Sa.y^(1/t)), m=m, t=t)
  v = vitalsens(el, vr)
  elas = v$elasticity
  names(elas) = rownames(v)
  return(elas)
}

# Above function allowing vector inputs for t
Ela_h = Vectorize(ela_h, "t")

# Function for plotting
plot.panel = function(
    Sj.y, # Juvenile yearly survival probability
    Sa.y, # Adult yearly survival probability 
    m,    # Fecundity
    il    # Vector of interval lengths in unit of days for reparameterization
  ){
  ES = Ela_S(Sj.y, Sa.y, m, 1/il)
  Eh = Ela_h(Sj.y, Sa.y, m, 1/il)
  plot(1,1, type="n", ylim=c(0,3), xlim=range(il), axes=F,
       xlab = "Survival interval length",
       ylab = expression(paste("Elasticity of  ", lambda)))
  box()
  axis(2)
  axis(1, at = c(7/365, 1/4, 1/2, 1, 2), labels=c("1w", "3m", "6m", "1y", "2y"))
  abline(v = c(7/365, 1/4, 1/2, 1, 2), col="grey")
  lines(il, ES["Sj.t",], col="blue", lty=2)
  lines(il, ES["Sa.t",], col="red", lty=2)
  lines(il, ES["m",], col="green")
  lines(il, -Eh["hj.t",], col="blue")
  lines(il, -Eh["ha.t",], col="red")
  legend("topright", title = " Elasticity to ...", title.adj=0, bg="white",
         legend=c("Juvenile survival", "Adult survival", "Juvenile mortality",
                  "Adult mortality", "Fecundity"),
         col=c("blue","red","blue","red","green"), lty=c(2,2,1,1,1))
  title(paste("Juvenile survival = ", Sj.y, "\nAdult survival = ", Sa.y, sep=""))
}

# Plotting:
par(mfrow = c(1,2))
plot.panel(Sj.y = 0.2, Sa.y = 0.6, m = 2, il = (1:(2*385))/365)
title("(a)", adj=0)
plot.panel(Sj.y = 0.6, Sa.y = 0.2, m = 2, il = (1:(2*385))/365)
title("(b)", adj=0)
```

#### Code - Figure 6
```{r, fig.height=6, fig.width=9, out.extra=''}
# Using functions from Fig. 5

library(RColorBrewer)  # for brewer.pal()

# Creating martices with elasticity ratios
n = 100
m = 2
Sj = seq(0.01,0.99,length.out=n)
Sa = seq(0.01,0.99,length.out=n)
Er.S = Er.h = matrix(NA, n, n)
for(i in 1:n){
  for(j in 1:n){
    ES = ela_S(Sj[i], Sa[j], m, 1)
    Eh = ela_h(Sj[i], Sa[j], m, 1)
    Er.S[i,j] = ES["Sa.t"]/ES["Sj.t"]
    Er.h[i,j] = Eh["ha.t"]/Eh["hj.t"]
  }
}

# Plotting
par(mfrow=c(1,2)) # Does not work with filled.contour()
Col = c(rev(brewer.pal(9,"Blues")), brewer.pal(9,"Reds"))
maxval = 6 
bins = seq(-maxval, maxval, length.out=19)

filled.contour(Sj, Sa, log(Er.S), levels=bins, nlevels=18, col=Col,
        plot.axes={axis(1); axis(2); text(c(0.2, 0.6), c(0.6, 0.2), c("a","b"),
                                          cex=1.3)},
        plot.title = title("Elasticity ratio - survival", cex.main=1.1,
                                  xlab="Juvenile survival", ylab="Adult survival"),
        key.title = title(main = "ln(ratio)", cex.main=0.9, line=1))
title("(a)", outer=T, adj=0.05, line=-2)
```
\setcounter{figure}{5} 

```{r, fig.height=6, fig.width=9, fig.cap="SETTER INN DETTE FRA MANUS TIL SLUTT", out.extra=''}
filled.contour(Sj, Sa, log(Er.h), levels=bins, nlevels=18, col=Col,
        plot.axes={axis(1); axis(2); text(c(0.2, 0.6), c(0.6, 0.2), c("a","b"), cex=1.3)},
        plot.title = title("Elasticity ratio -  - mortality rate", cex.main=1.1,
                                  xlab="Juvenile survival", ylab="Adult survival"),
        key.title = title(main = "ln(ratio)", cex.main=0.9, line=1))
title("(b)", outer=T, adj=0.05, line=-2)
```
### Figure 7

As shown in Figure 6 above, patterns in elasticities to mortality hazard rate are very different from patterns in elasticities to survival probability. One way to understand this is to note, as shown in Figure 7, that the relationship between $\log(S)$ and $\log(h)$ is very non-linear ($\log(S) = -\exp(\log(h))$ (the first derivative in this plot is -h). When the hazard rate is low (survival is high), a large relative change in the hazard rate (to the left in the figure) corresponds to a small relative change in survival probability. When the hazard rate is high (survival is low), a small relative change in the hazard rate corresponds to a large relative change in survival. This is also reflected in the relationship between elasticities to survival probability and elasticity to mortality hazard rate given above; $\epsilon_{\bar{h}} = -h\epsilon_S$.

#### Code - Figure 7
```{r, fig.height=6, fig.width=7, fig.cap="SETTER INN DETTE FRA MANUS TIL SLUTT", out.extra=''}
S = seq(0.001, 0.999, length.out=40)
y = log(S)
x = log(-log(S))

par(mai=c(1.2,1.2,1.2,1.2))
plot(x,y, xlab="ln(Mortality hazard rate)", ylab="ln(Survival probability)", type="n")

lS = c(0.001, 0.01, 0.1, 0.5, 0.9)

axis(3, at = log(-log(lS)), labels=as.character(lS), col.ticks="darkgrey",
     col.axis="darkgrey")
axis(4, at = log(lS), labels=as.character(lS), col.ticks="darkgrey", col.axis="darkgrey")
abline(h=log(lS), v=log(-log(lS)), col="darkgrey")
mtext("Survival probability",3, line=2.5, col="darkgrey")
mtext("Survival probability",4, line=2.5, col="darkgrey")
lines(x,y, lwd=2)
```

### Variance-stabilized sensitivities

In the final paragraph of this section in the main text, we comment on the use of variance-stabilized sensitivities (VSS) as defined by Link \& Doherty (2002). VSS are based on an assumed relationship between the temporal variance of a demographic parameter $\theta$ and the temporal mean $\mu$ of this parameter, which may be described as $\Var(\theta) = f(\mu)$. The delta-method approximation to the variance of a transformation $q(\theta)$ of this parameter is then
$$
\Var(q(\theta))
\approx \left( \frac{\partial q(\mu)}{\partial \mu} \right)^2 \Var(\theta)
= \left( q'(\mu) \right)^2 f(\mu).
$$
For a given variance-mean relationship $f(\mu)$ the transformation $q(\theta)$ is then said to be a variance-stabilizing transformation when $\Var(q(\theta))$ is independent of $\mu$, i.e., when $\left( q'(\mu) \right)^2 f(\mu)$ is a  constant. Link \& Doherty (2002) then defined the variance-stabilized sensitivity for a given variance-mean relationship as the sensitivity of $\log(\lambda)$ to the transformed parameter $q(\theta)$
$$
\VSS_q(\lambda,\theta)
= \frac{\partial \log(\lambda)}{\partial q(\theta)}
= \frac{\partial \lambda}{\partial \theta} \frac{\partial \theta}{\partial q(\theta)} \frac{1}{\lambda}
= \frac{\partial \lambda}{\partial \theta} \frac{1}{\lambda q'(\theta)}
$$
$\qquad$ To find the variance-mean relationship that corresponds with a particular variance stabilizing transformation $q(\theta)$, we need to solve $\left( q'(\mu) \right)^2 f(\mu) = C$ for $f(\mu)$ where $C$ is an arbitrary positive constant. When $q(\theta)$ is a logit-transformation of survival probability, we have $q(S) = \log \left( \frac{S}{1-S} \right)$ and hence
$$
f(\mu)
= C \left( q'(\mu) \right)^{-2}
= C \left( \frac{1}{\mu(1-\mu)} \right)^{-2}
= C \left( \mu(1-\mu) \right)^2
$$
Similarly, the loglog-link on survival probability, $q(S) = \log(-\log(S))$, is a variance stabilizing transformation when
$$
f(\mu)
= C \left( q'(\mu) \right)^{-2}
= C \left( \frac{1}{\mu\log(\mu)} \right)^{-2}
= C \left( \mu\log(\mu) \right)^2
$$
When using the loglog-link on survival probability, $q(S) = \log(-\log(S)) = \log(\bar{h})$, as a variance stabilizing transformation, the variance-stabilized sensitivity becomes
$$
\VSS_q(\lambda,S)
= \frac{\partial \log(\lambda)}{\partial q(\theta)}
= \frac{\partial \log(\lambda)}{\partial \log(\bar{h})}
= \epsilon_{\bar{h}}
$$
That is, using the loglog-link to obtain a variance-stabilized sensitivity to survival probability, assuming that the temporal variance in interval specific survival probabilities is proportional to $\left( \mu\log(\mu) \right)^2$, is equivalent to using the elasticity to time-averaged mortality hazard rate.





\newpage
\setcounter{section}{2}
\setcounter{subsection}{0}

# Appendix S2: Compteting risks and cause-specific mortality probabilities {-}

\renewcommand\thefigure{S\thesection.\arabic{figure}}    
\setcounter{figure}{0} 


```{r, echo=FALSE, fig.height=4, fig.width=10, fig.cap="SETTER INN DETTE FRA MANUS TIL SLUTT", out.extra=''}
set.seed(1)


# Box 2 Fig
red.events = runif(7, 0, 1.8)
blue.events = runif(3, 0, 1.8)
plot(0,0, axes=F, xlim=c(-0.2,1.8), ylim=c(-.1,.1), xlab="", ylab="", type="n")
arrows(-.2,0, 1.8, 0)
tlab = c(expression(t[1]), expression(t[2]))
axis(1, at=c(0,1), labels=tlab, pos=0, xlab="Time")
title(xlab="Time", line=-.2)
axis(1, at = red.events, labels=F, col.ticks="red", tcl=1, pos=0, lwd.ticks=2)
axis(1, at = blue.events, labels=F, col.ticks="blue", tcl=1.3, pos=0, lwd.ticks=3)

````

Figure X illustrates a situation where another (“blue”) cause of mortality has been added to the “red” cause of mortality illustrated in the figure in Box 1 in the main text. If we, for simplicity, assume that the hazard rates for these two causes of mortality are constant over an interval with values $h_1$ and $h_2$, the total mortality hazard rate is now $h_1+h_2$, and the probability of surviving the interval of length $\Delta t$ is $S=e^{-(h_1+h_2 )\Delta t}$.

$\qquad$ It is essential to realize that adding the blue cause of mortality in this example reduces the probability of dying from the red cause, even though the hazard rate representing the red cause remains the same. This is due to the fact that the individual now may die from a blue cause before a red event takes place. The probability of dying from a specific cause (often referred to as a "risk"), when the hazard rate of this cause remains unchanged, will always go down when the hazard rate of other mortality causes increase (or go up if the hazard rate of other causes decrease). One may say that the risks of death are "competing", and the probability of “winning” depends on the strength of the competitors (i.e., mortality probabilities are intrinsically linked). Hence, a change in the probability of dying of a specific cause may be due to changes in any of the cause specific mortality hazard rates. When studying e.g., environmental influence on different causes of mortality, or how different causes of mortality vary and co-vary among groups of individuals or among years within a population, it is therefore of prime interest to estimate the hazard rates of different causes of mortality rather than the probabilities of dying from different causes.

$\qquad$ Discrete-time models (such as classical capture recapture models) that incorporate different causes of mortality involve state-transition probability parameters representing the probabilities that an individual that is alive at one time-point ($t_1$) is either alive or dead from specific causes at a later point in time ($t_2$). These transition probabilities should sum to 1. Hence, $S + \sum_{k=1}^{K}{P_k} = 1$, where $S$ is the survival probability and the $P_k$'s are the probabilities of dying from different causes classified in $K$ categories. Assuming, for simplicity, that each of the cause specific hazard rates, $h_k$ are constant within intervals, we know from above that $S=e^{-\sum_{k=1}^{K}h_k\Delta t}$. To find the probability of dying from cause $k$, $P_k$, we may use the definition of hazard rates as
$$h(t) = \lim_{dt \rightarrow 0} \Pr(t  \leqslant T < t+dt|t<T)/dt$$
(Collett 2014) where $T$ is time of death and $dt$ is an infinitesimally small unit of time (i.e., $h(t)dt$ is the probability that the individual will die before time $t+dt$ given that it is alive at time $t$). From this we see that the relationship between the hazard rate and the probability density for time of death at time $t$, $f(t)$, is
$$h(t) = \frac{f(t)}{S(t)}$$ 		
where $S(t)$ is the probability of being alive at time $t$, which equals $1-\int_0^t f(t)dt$. Using this relationship, we can now find the probability density function for the time of death from cause $k$, $f_k(\tau)$, where $\tau=t-t_1$ is the time since the beginning of the interval,
$$f_k(\tau)=h_k e^{-\tau\sum_{l=0}^K h_l}$$
Note that this density function is not a proper probability distributions function as it does not integrate to 1 over infinite time. Instead, it integrates to the probability of ever dying from cause $k$, which in the case of constant hazard rates becomes $h_k/\sum_{l=1}^K h_l$. To find the probability of dying from cause $k$ before the end of the interval, we need to integrate $f_k (\tau)$ from $\tau=0$ to $\tau = \Delta t$ ($=t_2-t_1$), and get
$$P_k = \int_0^{\Delta t} f_k(\tau)d\tau = \left({ 1-e^{-\Delta t \sum_{l=1}^K h_l} }\right) \frac{h_k}{\sum_{l=1}^K h_l} = \left({ 1-S }\right) \frac{h_k}{\sum_{l=1}^K h_l}$$
This expression can be generalized to cases where cause specific hazard rates may vary over time but remain proportional throughout the interval such that $\alpha_k=h_k(t)/\sum_{l=1}^K h_l(t)$, in which case we get
$$P_k=(1-S)\alpha_k$$
$\qquad$ Note that the conditional probability of having died from cause $k$, given that the individual has died, in the case of proportional hazard rates is the fraction of the total mortality hazard rate attributed to the specific cause, $\alpha_k$, which in this case equals the probability of ever dying of this cause. This is, however, not the case when hazard rates are not proportional over time.

\newpage
\setcounter{section}{3}
\setcounter{subsection}{0}

# Appendix S3: Fitting capture-recapture models with cause-specific mortality {-}

## Introduction

When information about cause of death (e.g., harvesting) is available for at least a subset of marked individuals in the population, multi-state capture-recapture models can be fitted to the data to address questions relating to e.g. compensatory effects of harvesting or age-related patterns in mortality from different causes. However, commonly used software for fitting multi-state capture-recapture data such as MARK (White \& Burnham 1999) and E-SURGE (Choquet, Rouan \& Pradel 2009) use the multinomial logit-link function to constrain rows of the transition matrix to sum to 1. For example, the probability of transitioning from the alive state to death-by-cause state $k$ (i.e., probability of dying from cause $k$) may be modelled as
$$P_k = \frac{\exp(\eta_k)}{1+\sum_{l=1}^K \exp(\eta_l)},$$
while the probability of surviving is
$$S=1-\sum_{k=1}^K P_k = \frac{1}{1+\sum_{l=1}^K \exp(\eta_l)},$$
where $\eta_k$ is the linear predictor relating to cause $k$. This multinomial link-function does not facilitate modelling of cause-specific hazard rates (Appendix S2). Instead, based on the expressions for $S$ and $P_k$ derived in Appendix S2, we can model log-linear effects on the mortality hazard rates by using the multinomial link-function defined by
$$S=\exp \left( -\sum_{k=1}^K \exp(\eta_k) \right)$$
and
$$P_k = \left({ 1-S }\right) \frac{\exp(\eta_k)}{\sum_{l=1}^K \exp(\eta_l)}$$
$\qquad$ To facilitate model fitting using the above multinomial link-function, we modified the functions used for fitting multi-state capture-recapture models in the R-package ‘marked’ package (Laake, Johnson \& Conn 2013). This package combines a system for highly flexible model formulations (including modelling of covariate effects relating to time, age, cohort and individuals), similar to the popular 'RMarked' package, with highly efficient numerical optimization using automatic differentiation by executables compiled by the ADMB software (Fournier et al. 2012). The files are available on [Github], and a worked example using simulated data is included below.

## Example R-code

[I'm working on getting the files on Github and will include an example]

# References {-}

\begin{description}
  
  \item Choquet, R., Rouan, L. \& Pradel, R. (2009) Program E-SURGE: a software application for fitting multievent models. Modeling Demographic Processes in Marked Populations (eds D.L. Thompson, E.G. Cooch \& M.J. Conroy). Springer.
  
  \item Collett, D. (2014) Modelling survival data in medical research, Third edn. CRC Press.

  \item Fournier, D.A., Skaug, H.J., Ancheta, J., Ianelli, J., Magnusson, A., Maunder, M.N., Nielsen, A. \& Sibert, J. (2012) AD Model Builder: using automatic differentiation for statistical inference of highly parameterized complex nonlinear models. Optim. Methods Softw., 27, 233-249.

  \item Laake, J.L., Johnson, D.S. \& Conn, P.B. (2013) marked: An R package for maximum-likelihood and MCMC analysis of capture-recapture data. Methods in Ecology and Evolution, 4, 885-890.
  
  \item Link, W.A. \& Doherty, P.F. (2002) Scaling in sensitivity analysis. Ecology, 83, 3299-3305.
  
  \item Stubben, C.J. \& Milligan, B.G. (2007) Estimating and Analyzing Demographic Models Using the popbio Package in R. Journal of Statistical Software, 22(11).

  \item White, G.C. \& Burnham, K.P. (1999) Program MARK: Survival estimation from populations of marked animals. Bird Study, 46 Supplement, 120-138.

\end{description}

---
#[**Co-authors:** Sometimes I feel I spend too much time explaining rather obvious things in detail, but keep in mind that (1) those who will read this text are those that didn't get it from reading the main text, (2) few readers will probably read the whole appendix, but rather read the parts they are interested in (or did not understand), (3) we want to reach out to a wide audience (those that need to read it have not thought much about these issues before). Let me know if you think I go too far.]
---